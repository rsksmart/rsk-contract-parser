{"version":3,"file":"BcSearch.js","names":["_utils","require","_rskUtils","BcSearch","nod3","getBlock","hashOrNumber","eth","block","searchCb","highBlock","lowBlock","number","binarySearchNumber","err","Promise","reject","isContractAtBlock","address","blockNumber","code","getCode","parseInt","isNaN","deploymentBlock","searchReceipt","transactions","cb","tx","receipt","getTransactionReceipt","hash","isItxDeployment","itx","result","type","contractAddress","undefined","deploymentTx","blockTrace","filter","isAddress","to","transaction","trace","internalTx","find","timestamp","Object","freeze","_default","exports","default"],"sources":["../../src/lib/BcSearch.js"],"sourcesContent":["import { binarySearchNumber } from './utils'\nimport { isAddress } from '@rsksmart/rsk-utils'\n\nexport function BcSearch (nod3) {\n  const getBlock = (hashOrNumber) => {\n    return nod3.eth.getBlock(hashOrNumber)\n  }\n\n  const block = async (searchCb, highBlock, lowBlock) => {\n    try {\n      if (!highBlock) {\n        let block = await getBlock('latest')\n        let { number } = block\n        highBlock = number\n      }\n      lowBlock = lowBlock || 1\n      return binarySearchNumber(searchCb, highBlock, lowBlock)\n    } catch (err) {\n      return Promise.reject(err)\n    }\n  }\n\n  const isContractAtBlock = async (address, blockNumber) => {\n    let code = await nod3.eth.getCode(address, blockNumber)\n    code = parseInt(code)\n    return !isNaN(code) && code > 0\n  }\n\n  const deploymentBlock = (address, highBlock, lowBlock) => {\n    return block(blockNumber => isContractAtBlock(address, blockNumber), highBlock, lowBlock)\n  }\n  const searchReceipt = async (transactions, cb) => {\n    for (let tx of transactions) {\n      let receipt = await nod3.eth.getTransactionReceipt(tx.hash)\n      if (cb(receipt)) return { tx, receipt }\n    }\n  }\n  const isItxDeployment = (address, itx) => {\n    let { result, type } = itx\n    let contractAddress = (result) ? result.address : undefined\n    return type === 'create' && contractAddress === address\n  }\n  const deploymentTx = async (address, { blockNumber, blockTrace, block, highBlock } = {}) => {\n    try {\n      blockNumber = blockNumber || await deploymentBlock(address, highBlock)\n      block = block || await nod3.eth.getBlock(blockNumber, true)\n      let transactions = block.transactions.filter(tx => !isAddress(tx.to))\n      let transaction = await searchReceipt(transactions, receipt => receipt.contractAddress === address)\n      if (!transaction) { // internal transactions\n        blockTrace = blockTrace || await nod3.trace.block(block.hash)\n        let internalTx = blockTrace.find(trace => isItxDeployment(address, trace))\n        if (internalTx) transaction = { internalTx }\n      }\n      if (transaction) transaction.timestamp = block.timestamp\n      return transaction\n    } catch (err) {\n      return Promise.reject(err)\n    }\n  }\n\n  return Object.freeze({ block, deploymentBlock, deploymentTx, isItxDeployment })\n}\n\nexport default BcSearch\n"],"mappings":"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"}