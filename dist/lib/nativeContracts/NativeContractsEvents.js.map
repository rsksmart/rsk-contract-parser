{"version":3,"file":"NativeContractsEvents.js","names":["_rskUtils","require","_utils","_FakeABI","_interopRequireDefault","obj","__esModule","default","NativeContractsEvents","bitcoinNetwork","network","fakeAbi","FakeAbi","decodeAddress","address","Buffer","from","remove0x","add0x","toString","slice","decodeEventName","name","replace","removeEmptyStartBytes","d","isBuffer","findIndex","x","decodeData","data","decoded","rlp","decode","Array","isArray","map","getEventAbi","eventName","find","a","type","decodeByType","value","decodeInput","input","_filter","removeCustomProperties","res","Object","assign","p","cleanAbi","abi","inputs","decodeLog","log","topics","event","shift","signature","getSignatureDataFromAbi","args","decoder","_decoder","dataDecoded","i","indexed","length","push","freeze","_default","exports"],"sources":["../../../src/lib/nativeContracts/NativeContractsEvents.js"],"sourcesContent":["import { remove0x, add0x, rlp } from '@rsksmart/rsk-utils'\nimport { getSignatureDataFromAbi } from '../utils'\nimport FakeAbi from './FakeABI'\nexport function NativeContractsEvents ({ bitcoinNetwork } = {}) {\n  const network = bitcoinNetwork || 'testnet'\n  const fakeAbi = FakeAbi(network)\n  const decodeAddress = address => {\n    address = Buffer.from(remove0x(address), 'hex')\n    return add0x(address.toString('hex').slice(-40))\n  }\n\n  const decodeEventName = name => {\n    return Buffer.from(remove0x(name), 'hex').toString('ascii').replace(/\\0/g, '')\n  }\n\n  const removeEmptyStartBytes = d => {\n    d = (!Buffer.isBuffer(d)) ? Buffer.from(d, 'hex') : d\n    return d.slice(d.findIndex(x => x > 0))\n  }\n\n  const decodeData = data => {\n    let decoded = rlp.decode(data)\n    if (!Array.isArray(decoded)) decoded = [decoded]\n    return decoded.map(d => add0x(removeEmptyStartBytes(d).toString('hex')))\n  }\n\n  const getEventAbi = eventName => fakeAbi.find(a => a.name === eventName && a.type === 'event')\n\n  const decodeByType = (type, value) => {\n    if (type === 'address') return decodeAddress(value)\n    return value\n  }\n\n  const decodeInput = (input, value) => {\n    let { type, _filter } = input\n    if (_filter && typeof _filter === 'function') {\n      value = _filter(value)\n    }\n    return decodeByType(type, value)\n  }\n\n  const removeCustomProperties = obj => {\n    const res = Object.assign({}, obj)\n    for (let p in res) {\n      if (p[0] === '_') delete res[p]\n    }\n    return res\n  }\n\n  const cleanAbi = abi => {\n    abi = removeCustomProperties(abi)\n    let { inputs } = abi\n    if (Array.isArray(inputs)) abi.inputs = inputs.map(input => removeCustomProperties(input))\n    return abi\n  }\n\n  const decodeLog = log => {\n    let topics = [...log.topics]\n    let event = decodeEventName(topics.shift())\n    let abi = getEventAbi(event)\n    if (event && abi) {\n      const { signature } = getSignatureDataFromAbi(abi)\n      log.event = event\n      log.signature = signature\n      log.abi = cleanAbi(abi)\n      log.args = []\n      const decoder = abi._decoder || decodeData\n      let dataDecoded = decoder(log.data)\n      if (!Array.isArray(dataDecoded)) dataDecoded = [dataDecoded]\n      for (let i in abi.inputs) {\n        let input = abi.inputs[i]\n        let { indexed } = input\n        let value = (indexed === true) ? topics[i] : dataDecoded[i - topics.length]\n        let decoded = decodeInput(input, value)\n        if (decoded) log.args.push(decoded)\n      }\n    }\n    return log\n  }\n  return Object.freeze({ decodeLog, abi: fakeAbi })\n}\n\nexport default NativeContractsEvents\n"],"mappings":"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"}