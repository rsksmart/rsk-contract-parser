{"version":3,"file":"compileJsonAbis.js","names":["_fs","_interopRequireDefault","require","_util","_path","_types","_utils","obj","__esModule","default","readDir","util","promisify","fs","readdir","readFile","writeFile","jsonPath","__dirname","ozPath","path","resolve","destinationFile","compileAbi","then","abi","JSON","stringify","console","log","process","exit","dirs","jsonFiles","dir","files","filter","file","extname","length","Error","concat","map","Promise","all","readJson","content","Array","isArray","reduce","a","v","i","array","processAbi","err","json","parse","reject","type","Set","addSignatureDataToAbi","signatures","ABI_SIGNATURE","signature","fourBytes","s","slice","indexOf","filterEvents","on","error"],"sources":["../../src/lib/compileJsonAbis.js"],"sourcesContent":["import fs from 'fs'\nimport util from 'util'\nimport path from 'path'\nimport { ABI_SIGNATURE } from './types'\nimport { addSignatureDataToAbi, filterEvents } from './utils'\n\nconst readDir = util.promisify(fs.readdir)\nconst readFile = util.promisify(fs.readFile)\nconst writeFile = util.promisify(fs.writeFile)\n\nconst jsonPath = `${__dirname}/jsonAbis`\nconst ozPath = path.resolve('node_modules/openzeppelin-solidity/build/contracts')\nconst destinationFile = `${__dirname}/compiled_abi.json`\n\ncompileAbi([jsonPath, ozPath]).then(abi => {\n  writeFile(destinationFile, JSON.stringify(abi, null, 2))\n    .then(() => {\n      console.log(`New ABI saved on ${destinationFile}`)\n      process.exit(0)\n    })\n})\n\nasync function compileAbi (dirs) {\n  try {\n    let jsonFiles = []\n    for (let dir of dirs) {\n      let files = await readDir(dir)\n      files = files.filter(file => path.extname(file) === '.json')\n      if (!files || !files.length) throw new Error(`No json files in dir ${dir}`)\n      jsonFiles = jsonFiles.concat(files.map(file => `${dir}/${file}`))\n    }\n    let abi = await Promise.all(jsonFiles.map(file => readJson(`${file}`).then(content => {\n      return (Array.isArray(content)) ? content : content.abi\n    })))\n    if (!abi) throw new Error(`Invalid abi `)\n    abi = abi.reduce((a, v, i, array) => v.concat(a))\n    abi = processAbi(abi)\n    return abi\n  } catch (err) {\n    console.log('Compile Error', err)\n    process.exit(9)\n  }\n}\n\nasync function readJson (file) {\n  console.log(`Reading file ${file}`)\n  try {\n    let json = await readFile(file, 'utf-8')\n    return JSON.parse(json)\n  } catch (err) {\n    console.log(file, err)\n    return Promise.reject(err)\n  }\n}\n\nexport function processAbi (abi) {\n  // remove fallbacks\n  abi = abi.filter(a => a.type !== 'fallback')\n  // remove duplicates\n  abi = [...new Set(abi.map(a => JSON.stringify(a)))].map(a => JSON.parse(a))\n  // add signatures\n  abi = addSignatureDataToAbi(abi)\n  // detect 4 bytes collisions\n  let signatures = (abi.map(a => a[ABI_SIGNATURE].signature)).filter(v => v)\n  signatures = [...new Set(signatures)]\n  let fourBytes = signatures.map(s => s.slice(0, 8))\n  if (fourBytes.length !== [...new Set(fourBytes)].length) {\n    console.log(fourBytes.filter((v, i) => fourBytes.indexOf(v) !== i))\n    throw new Error('4bytes collision')\n  }\n  // filter events\n  abi = filterEvents(abi)\n  return abi\n}\n\nprocess.on('unhandledRejection', err => {\n  console.error(err)\n  process.exit(9)\n})\n"],"mappings":"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"}